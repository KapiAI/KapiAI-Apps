# ã€æ•™ç¨‹ã€‘ç”¨ AI çœ‹èˆŒè‹”ï¼Ÿæˆ‘ç”¨é€šä¹‰åƒé—®å¼€å‘äº†ä¸€ä¸ª AI èˆŒè¯Šåº”ç”¨

> ç¬”è€…ç›®å‰æ­£åœ¨æŒ‘æˆ˜åŸºäºå›½å†…çš„å¤§æ¨¡å‹åˆ›å»º 10ä¸ªAIåº”ç”¨ï¼Œç›¸å…³çš„è¿è½½æ•™ç¨‹ + Demoä½“éªŒåœ°å€ä¼šåœ¨[Githubä»“åº“](https://github.com/KapiAI/KapiAI-Apps)æŒç»­æ›´æ–°ã€‚
>
> è¿™æ˜¯åŸºäºå›½å†…å¤§æ¨¡å‹åˆ›å»º AI åº”ç”¨çš„ç¬¬ 2 æœŸã€‚AI åº”ç”¨çš„å¼€å‘è¿‡ç¨‹ä¼šåŒæ­¥åˆ° B ç«™ï¼š [@å¡çš® AI](https://space.bilibili.com/39930228)ï¼Œæ¬¢è¿å¤§å®¶å…³æ³¨ã€‚



## é¡¹ç›®ä»‹ç»

ç¬”è€…ç›®å‰æ­£åœ¨æŒ‘æˆ˜ï¼šç”¨å›½å†…çš„å¤§æ¨¡å‹å¼€å‘ 10 æ¬¾æœ‰è¶£çš„ AI åº”ç”¨ï¼ˆåŸºäº webï¼‰ã€‚è¿™ 10 æ¬¾ AI åº”ç”¨çš„å¼€å‘è¿‡ç¨‹æˆ‘éƒ½ä¼šåŒæ­¥å‘å¸ƒåˆ° B ç«™ @ å¡çš® AIï¼Œå¹¶ä¸”éƒ½ä¼šé™„å¸¦ä½“éªŒåœ°å€ + è¯¦ç»†æ•™ç¨‹  +  æºç ã€‚

æ‰€æœ‰çš„é¡¹ç›®éƒ½æ˜¯åŸºäº TailwindCSS å®ç°äº†å“åº”å¼ï¼ŒåŒæ—¶æ”¯æŒç½‘é¡µç«¯å’Œç§»åŠ¨ç«¯çš„æ˜¾ç¤ºæ•ˆæœã€‚

è¿™æœŸå°è¯•å¼€å‘çš„ AI åº”ç”¨æ˜¯ä½¿ç”¨é€šä¹‰åƒé—®çš„å¤§æ¨¡å‹ APIï¼Œå¼€å‘ä¸€ä¸ª AI çœ‹èˆŒè‹”çš„åº”ç”¨ã€‚

![](static/FfWAb81kMowBZhxOe2HcSkDonke.png)

æ•´ä¸ªé¡¹ç›®çš„æ“ä½œæµç¨‹æ¯”è¾ƒç®€å•ï¼Œç¬¬ä¸€å±ç”¨æˆ·ä¸Šä¼ è‡ªå·±çš„èˆŒå¤´çš„ç…§ç‰‡ï¼Œ ä¿å­˜åˆ° OSS ä¸­ã€‚ç„¶åå°† OSS ä¿å­˜çš„å›¾ç‰‡å‘é€ç»™é€šä¹‰åƒé—®çš„å¤§æ¨¡å‹ï¼ˆè¿™é‡Œé‡‡ç”¨äº† qwen-vl  + qwen-max ä¸¤ä¸ªå¤§æ¨¡å‹ï¼‰ï¼Œè®©å¤§æ¨¡å‹ç”Ÿæˆæˆ‘ä»¬çš„å‰ç«¯ JSON æ•°æ®å¹¶è¿”å›

![](static/Bfe9b0ZdDoo2fNxqFA7cEOe8nac.png)

æ•´ä¸ªé¡¹ç›®ä½¿ç”¨åˆ°çš„æŠ€æœ¯æ ˆå¦‚ä¸‹ï¼š

- å‰ç«¯

  - [Nuxt.js](https://nuxt.com/)ï¼šåŸºäº Vue çš„ SSR å’Œ SSG æ¡†æ¶
  - [Tailwind CSS](https://tailwindcss.com/)ï¼š åŸå­æ€§çš„ CSS æ¡†æ¶ï¼Œèƒ½å¾ˆæ–¹ä¾¿çš„çš„å®ç°æ ·å¼çš„æ­å»º
  - [VantUI](https://vant-ui.github.io/vant/)ï¼šè½»é‡ã€å¯å®šåˆ¶çš„ç§»åŠ¨ç«¯ç»„ä»¶åº“
  - [Supabase](https://memfiredb.com/)ï¼šç›®å‰åŸºäºçš„ MemFire Cloud çš„ supabase æ–¹æ¡ˆ
- åç«¯

  - [Midway.js](https://midwayjs.org/)ï¼šé˜¿é‡Œå‡ºçš„ Node.js æ¡†æ¶
  - [Supabase](https://memfiredb.com/)ï¼šç›®å‰åŸºäºçš„ MemFire Cloud çš„ supabase æ–¹æ¡ˆï¼Œå®ç°æ•°æ®åº“å­˜å‚¨ã€OSSã€é‰´æƒ
- AI

  - [OpenAI](https://www.npmjs.com/package/openai)ï¼š OpenAI çš„ Node.js SDK
  - [é˜¿é‡Œäº‘ DashScope](https://dashscope.aliyun.com)ï¼šæ”¯æŒé€šä¹‰åƒé—®çš„èƒ½åŠ›ç›´æ¥è°ƒç”¨

## å‰ç«¯å¼€å‘

å‰ç«¯ä½¿ç”¨æ˜¯ Nuxt3ï¼Œé¦–é¡µçš„å‰ç«¯ä»£ç å¦‚ä¸‹ï¼Œæ ¸å¿ƒæ˜¯ä¸¤ä¸ªç»„ä»¶ `UploadForm.vue` å’Œ `ReportData.vue`ã€‚åˆ†åˆ«å¯¹åº”ä¸Šé¢æåˆ°çš„ä¸Šä¼ é¡µé¢å’ŒæŠ¥å‘Šé¡µé¢

```javascript
<template>
  <div class="ai-shetai_page h-full">
    _<!-- é¡µé¢ä¿¡æ¯ -->_
    <Head>
      <Title>AIå¤œå¸‚Â·çœ‹çœ‹èˆŒè‹”Demo</Title>
      <Meta
        name="description"
        content="AIå¤œå¸‚: ä¸€ä¸ªAIçœ‹èˆŒè‹”ğŸ‘…çš„Demoåº”ç”¨ï¼Œå¤§æ¨¡å‹é‡‡ç”¨çš„é˜¿é‡Œé€šä¹‰åƒé—®qwen-plusï¼ˆç”¨äºæ–‡æœ¬ç”Ÿæˆï¼‰+ qwen-vl-maxï¼ˆç”¨äºå›¾åƒç†è§£ï¼‰ã€‚"
      />
      <Style
        type="text/css"
        children="body { background-color: white; }"
      ></Style>
    </Head>

    _<!-- ä¸»ä½“ -->_
    <main class="h-full flex">
      _<!-- å·¦ä¾§ -->_
      <div class="flex hidden lg:block">
        <img
          class="h-screen"
          style="max-width: fit-content"
          src="/images/ai-girl-shetou.png"
          alt="doctor-girl"
        />
      </div>
      _<!-- å³ä¾§ -->_
      <div class="flex-grow h-full overflow-y-auto p-8 lg:px-16 lg:py-14">
        <div class="max-w-2xl m-auto">
          <h2
            class="flex items-center text-3xl lg:text-5xl text-slate-800 font-bold"
          >
            <span>AIÂ·çœ‹çœ‹èˆŒè‹”</span>
            <img class="w-12 h-12 rounded-full ml-2" src="/images/logo.png" />
          </h2>
          <p class="text-sm mt-4 text-slate-700">
            ä¸€ä¸ªAIçœ‹èˆŒè‹”ğŸ‘…çš„Demoåº”ç”¨ï¼Œå¤§æ¨¡å‹é‡‡ç”¨çš„é˜¿é‡Œé€šä¹‰åƒé—®qwen-plusï¼ˆç”¨äºæ–‡æœ¬ç”Ÿæˆï¼‰
            + qwen-vl-maxï¼ˆç”¨äºå›¾åƒç†è§£ï¼‰ã€‚
          </p>
          <p class="text-sm mt-0 text-slate-700">
            å¤§æ¨¡å‹Tokenå¾ˆè´µï¼Œéœ€å……å€¼ä¸€ä¸¢ä¸¢tokenè¿›è¡Œä½“éªŒğŸ˜šã€‚ä½ å¦‚æœæ˜¯å¼€å‘è€…ğŸ‘¨â€ğŸ’»ï¼Œä¹Ÿå¯ä»¥è·å–æºä»£ç è‡ªè¡Œéƒ¨ç½²ï¼Œç›®å‰å„å¤§æ¨¡å‹éƒ½æœ‰å…è´¹token!
          </p>
          <div class="bg-white mt-8 rounded-lg p-4 max-w-full lg:max-w-2xl">
            _<!-- ä¸Šä¼ èˆŒå¤´ç…§ç‰‡ -->_
            <UploadForm v-if="type === 'upload'" />
            _<!-- èˆŒè±¡åˆ†æ -->_
            <ReportData v-else />
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script setup>
import { toRefs } from "vue";
import useProjectShetaiStore from "@/store/shetai";

const projectShetaiStore = useProjectShetaiStore();
const { type } = toRefs(projectShetaiStore);
</script>

<style>
.ai-shetai_page {
  background-image: linear-gradient(
    45deg,
    #ff9a9e 0%,
    #fad0c4 99%,
    #fad0c4 100%
  );
}
</style>
```

### ä¸Šä¼ é¡µé¢

![](static/T8jNbxnyHorxSOxFo7AcJK7knxh.jpg)

`UploadForm.vue` ä¸Šä¼ ç»„ä»¶æ‰€å¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼Œä¸Šä¼ é‡‡ç”¨çš„æ˜¯ vant çš„ä¸Šä¼ ç»„ä»¶ã€‚

```javascript
<template>
  <div>
    _<!-- ä¸Šä¼ ç…§ç‰‡ -->_
    <div>
      <label
        for="username"
        class="block text-sm font-medium leading-6 text-gray-900"
        >ä¸Šä¼ ä½ çš„ğŸ‘…ç…§ç‰‡</label
      >
      <van-uploader
        class="mt-2"
        v-model="fileList"
        reupload
        max-count="1"
        accept="image/*"
        max-size="5 * 1024 * 1024"
        :after-read="afterRead"
        @delete="onDelete"
      />
    </div>
    _<!-- ç”ŸæˆæŠ¥å‘Šçš„æŒ‰é’® -->_
    <div class="mt-4">
      <van-button
        type="primary"
        class="!bg-pink-400 border !border-pink-400"
        :class="{
          'cursor-wait': isGenerating,
        }"
        :disabled="isDisabled"
        @click="projectShetaiStore.generateReport(uploadUrl)"
        >ç”ŸæˆæŠ¥å‘Š</van-button
      >
    </div>

    _<!-- ç”Ÿæˆæ—¶çš„loadingæ•ˆæœ -->_
    <van-overlay :show="isGenerating">
      <div class="mt-[25vh]" @click.stop>
        <CubeLoading
          textCSS="text-white text-center leading-6 text-sm mt-4"
          text="AIæ­£åœ¨åˆ†æè¯Šæ–­ä¸­ğŸ”<br/> è¿™ä¸€æ­¥è€—æ—¶æ¯”è¾ƒä¹…ï¼ˆå¯èƒ½30s - 60sï¼‰ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ğŸ™"
        />
      </div>
    </van-overlay>
  </div>
</template>

<script setup>
import { computed, toRefs } from "vue";
import { BUCEKT } from "@/utils/constants";
import useUpload from "@/composables/useUpload";
import useProjectShetaiStore from "@/store/shetai";

_// ä¸Šä¼ æ–‡ä»¶_
const { fileList, uploadUrl, afterRead, onDelete } = useUpload(BUCEKT.SHE_TAI);

_// ç”ŸæˆæŠ¥å‘Š_
const projectShetaiStore = useProjectShetaiStore();
const { isGenerating } = toRefs(projectShetaiStore);

_// æ˜¯å¦ç¦ç”¨ç”ŸæˆæŠ¥å‘Šçš„æŒ‰é’®_
const isDisabled = computed(() => !uploadUrl.value || isGenerating.value);
</script>
```

å›¾ç‰‡ä¸Šä¼ åˆ° OSS çš„é€»è¾‘ï¼Œæˆ‘æ˜¯é‡‡ç”¨çš„å¼€æºçš„ Supabase æ–¹æ¡ˆï¼Œæ ¸å¿ƒçš„ä¸Šä¼ ä»£ç é€»è¾‘å°è£…åˆ°äº† `@/composables/useUpload.js` ä¸­ã€‚æˆ‘å®ƒçš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š

```javascript
import { ref, toRefs } from "vue";
import moment from "moment";
import { nanoid } from "nanoid";
import { showFailToast, showSuccessToast } from "vant";
import { useSupabase } from "@/composables/useSupabase";

const useUpload = (bucketName) => {
  _// supabaseå®ä¾‹_
  const supabase = useSupabase();
  _// æ–‡ä»¶åˆ—è¡¨_
  const fileList = ref([]);
  _// æ–‡ä»¶ä¸Šä¼ æˆåŠŸåœ°å€_
  const uploadUrl = ref("");

  async function uploadImageToOSS(vantFile) {
    const { file } = vantFile;
    const filename = file.name;
    const date = moment().format("YYYY-MM-DD");
    const uid = nanoid(10);
    const PATH = `images/${date}/${uid}-${filename}`;

    const { data, error } = await supabase.storage
      .from(bucketName)
      .upload(PATH, file, {
        cacheControl: "3600",
        upsert: false,
      });

    return {
      data,
      error,
    };
  }

  _// è¯»å–æ–‡ä»¶å®Œæ¯•è§¦å‘çš„å›è°ƒ_
  async function afterRead(vantFile) {
    vantFile.status = "uploading";
    const res = await uploadImageToOSS(vantFile);

    if (res.error) {
      vantFile.status = "failed";
      const errorMsg = res.error.error || res.error.message || "ä¸Šä¼ å¤±è´¥";
      showFailToast(errorMsg);
    } else {
      const { data } = supabase.storage
        .from(bucketName)
        .getPublicUrl(res.data.path);

      const { publicUrl } = data;
      vantFile.status = "done";
      uploadUrl.value = publicUrl;

      showSuccessToast("ä¸Šä¼ æˆåŠŸ");
    }
  }

  _// åˆ é™¤æ–‡ä»¶è§¦å‘çš„å›è°ƒ_
  function onDelete() {
    uploadUrl.value = "";
  }

  return {
    fileList,
    uploadUrl,
    afterRead,
    onDelete,
  };
};

export default useUpload;
```

è¿™è¾¹ Supabase æ–¹æ¡ˆé‡‡ç”¨çš„æ˜¯ [MemfireDB](https://memfiredb.com/) çš„æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒæä¾›äº†å¾ˆå¥½çš„å›½å†…è®¿é—®æ€§ï¼Œè€Œä¸”å¼€å‘è€…å…·æœ‰åˆ›å»º 2 ä¸ªå…è´¹é¢åº¦çš„æƒç›Šã€‚æˆ‘å¾ˆå®‰åˆ©ç‹¬ç«‹å¼€å‘è€…ä½¿ç”¨ Supabase å¼€å‘é¡¹ç›®ï¼Œå› ä¸ºå®ƒæä¾›äº†æ•°æ®åº“ã€OSS å­˜å‚¨å’Œç™»å½•é‰´æƒæ–¹æ¡ˆï¼Œåªéœ€è¦è°ƒç”¨ä¸€ä¸ªå‡½æ•°å°±èƒ½å®ç°åç«¯åŠŸèƒ½ï¼Œèƒ½å¤Ÿæå¤§çš„æé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ï¼Œå¯¹å‰ç«¯åŒå­¦éå¸¸å‹å¥½ã€‚

å¹¶ä¸”ä¸åƒ Google æä¾›çš„ Firebaseï¼Œå›½å†…çš„è®¿é—®æ€§ä¸ä½³ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€å¥—æŠ€æœ¯æ ˆï¼Œå®ç°å›½å†…å’Œæµ·å¤–çš„ Supabase æ–¹æ¡ˆåŒæ„ã€‚

### æŠ¥å‘Šé¡µé¢

![](static/IGlub4VMno8a8cxa5M1cdsben3f.png)

ä¸Šä¼ æˆåŠŸåå°±å¯ä»¥ç‚¹å‡»ç”ŸæˆæŠ¥å‘Šï¼Œå› ä¸ºå¤§æ¨¡å‹çš„å“åº”æ—¶é—´æ¯”è¾ƒä¹…ï¼Œæˆ‘è¿™è¾¹æ²¡æœ‰è€ƒè™‘å¢åŠ  stream è¿”å›æ•°æ®ç­‰ç›¸å…³ä¼˜åŒ–ã€‚æ‰€ä»¥å¢åŠ äº†ä¸€ä¸ª loading çš„åŠ¨æ•ˆã€‚ä¸Šä¼ ç»„ä»¶ `ReportData.vue` çš„æºç å¦‚ä¸‹ï¼š

```typescript
<template>
  <div>
    <h3 class="font-medium">åˆ†ææŠ¥å‘Š</h3>
    <div class="mt-4 bg-slate-50 px-4 py-2 rounded-lg text-sm">
      {{ comment }}
    </div>
    <div class="mt-4">
      <div
        class="flex items-center mt-2 text-sm border px-4 py-4 rounded text-gray-800"
        v-for="(item, index) in diagnosis"
        :key="item.id"
      >
        <div class="flex-grow">
          <div class="font-medium">{{ item.id }}:{{ item.name }}</div>
          <div class="mt-2 flex">
            <i class="rounded-full w-1 h-1 bg-pink-500 mt-2 mr-2 flex-none"></i
            >ç‰¹ç‚¹ï¼š{{ item.feature }}
          </div>
          <div class="mt-2 flex">
            <i class="rounded-full w-1 h-1 bg-pink-500 mt-2 mr-2 flex-none"></i
            >è¯Šæ–­ï¼š{{ item.diagnosis }}
          </div>
        </div>
        <div class="flex-none rounded-full border p-1 border-pink-400 ml-2">
          <img class="w-8 h-8 rounded-full" :src="`/images/${index + 1}.jpg`" />
        </div>
      </div>
    </div>

    <div class="mt-4 flex justify-end">
      <van-button
        type="primary"
        class="!bg-pink-400 border !border-pink-400"
        :class="{
          'cursor-wait': isGenerating,
        }"
        @click="() => projectShetaiStore.clearCache()"
        >å†æµ‹ä¸€æ¬¡</van-button
      >
    </div>
  </div>
</template>

<script setup>
import { computed, toRefs } from "vue";
import useProjectShetaiStore from "@/store/shetai";

const projectShetaiStore = useProjectShetaiStore();
const { reportData } = toRefs(projectShetaiStore);

function parseAIJSON(aiContent) {
  const content = aiContent.replace(/\\n/g, "");
  const regex = /```json\s([\s\S]*?)\s```/;
  const matches = content.match(regex);

  if (matches && matches.length) {
    try {
      const jsonString = matches[1];
      const data = JSON.parse(jsonString);

      return data;
    } catch (error) {
      console.error(error);
      return null;
    }
  } else {
    return null;
  }
}

const data = computed(() => {
  let json = parseAIJSON(reportData.value);
  return json;
});

const comment = computed(() => {
  if (data.value && data.value.comment) {
    return data.value.comment;
  } else {
    return "AIåˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚";
  }
});

const diagnosis = computed(() => {
  if (data.value && data.value.data) {
    const keys = Object.keys(data.value.data);
    const result = keys.map((key) => {
      const item = data.value.data[key];
      return {
        id: key,
        name: item.name,
        feature: item.feature,
        diagnosis: item.diagnosis,
      };
    });

    return result;
  } else {
    return [];
  }
});
</script>
```

## åç«¯  + å¤§æ¨¡å‹

åç«¯é‡‡ç”¨çš„æ˜¯ Midwayï¼Œè°ƒç”¨é€šä¹‰åƒé—®æ¨¡å‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å»[é˜¿é‡Œäº‘ DashScope](https://dashscope.aliyun.com) ç”³è¯· OpenAIKeyï¼Œå¡«å†™åˆ°æˆ‘ä»¬çš„ç¯å¢ƒå˜é‡é‡Œé¢ã€‚é˜¿é‡Œäº‘é€äº†å¾ˆæ…·æ…¨çš„ token é¢åº¦ï¼Œæˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘è´¹ç”¨é—®é¢˜ï¼Œæ ¹æœ¬ç”¨ä¸å®Œï¼

### openai åº“

é€šä¹‰åƒé—®çš„å¤§è¯­è¨€æ¨¡å‹æ˜¯æ”¯æŒäº† openai åº“çš„å…¼å®¹çš„ï¼ˆqwen-vl è§†è§‰æ¨¡å‹è¿˜æš‚æ—¶ä¸æ”¯æŒï¼‰ï¼Œè¿™è¾¹ä½ å¯ä»¥è°ƒç”¨ `/api/test`ï¼Œé¡ºåˆ©çš„è¯å°±èƒ½å¤Ÿè·å–åˆ°é€šä¹‰åƒé—®è¿”å›çš„æ•°æ®ã€‚

```typescript
import OpenAI from 'openai';
import { Inject, Controller, Get } from '@midwayjs/core';
import { Context } from '@midwayjs/koa';
import { ApiService } from '../service/api.service';
import { env } from '../config/config.env';

@Controller('/api/')
export class APIController {
  @Inject()
  ctx: Context;

  @Inject()
  apiService: ApiService;

  _/**_
_   * æµ‹è¯•æ¨¡å‹çš„è¿æ¥ï¼ˆæœ¬åœ°ç¯å¢ƒå¯ä»¥ç”¨ï¼‰_
_   */_
  @Get('/test')
  async getTest() {
    _// åˆ¤æ–­æ˜¯å¦æ˜¯å¼€å‘ç¯å¢ƒï¼ˆé¿å…ç”Ÿäº§ç¯å¢ƒå¯¼è‡´tokençš„æ¶ˆè€—ï¼‰_
    const isDev = env === 'development';

    if (!isDev) {
      return {
        success: false,
        info: 'éå¼€å‘ç¯å¢ƒä¸å¯ç”¨ï¼Œé¿å…tokenæ¶ˆè€—',
      };
    }

    _// è°ƒç”¨çš„å‚æ•°_
    const params: OpenAI.Chat.ChatCompletionCreateParams = {
      messages: [{ role: 'user', content: 'ä½ å¥½å•Šï¼Œä½ æ˜¯è°ï¼Ÿä½ èƒ½åšä»€ä¹ˆï¼Ÿ' }],
      model: 'qwen-plus',
    };

    _// æ•°æ®è¿”å›_
    return this.apiService.getQwenChat(params);
  }
}
```

### ç¼–å†™ prompt

è¿™è¾¹çš„ prompt æ ¸å¿ƒé€»è¾‘éƒ½åœ¨ `/api/shetai` è¿™ä¸ª controller æ‰€å¯¹åº”çš„ä»£ç ä¸­

```typescript
import { Inject, Controller, Post, Body } from '@midwayjs/core';
import { Context } from '@midwayjs/koa';
import OpenAI from 'openai';
import { IQwenVlData } from '../types/index';
import { ShetaiService } from '../service/shetai.service';

const SHENZHI_DATA = require('../jsons/shezhi.data.json');
const SHETAI_DATA = require('../jsons/shetai.data.json');

@Controller('/api/shetai')
export class APIController {
  @Inject()
  ctx: Context;

  @Inject()
  apiService: ShetaiService;

  _/**_
_   * å®ç°èˆŒè‹”è¯Šæ–­_
_   */_
  @Post('/diagnosis')
  async getDiagnosis(@Body() body: any) {
    const { imageUrl } = body;
    if (!imageUrl) {
      return {
        success: false,
        info: 'ç¼ºå°‘å›¾ç‰‡å‚æ•°',
      };
    }
    _// è°ƒç”¨ API_
    const vlBody = {
      model: 'qwen-vl-max',
      parameters: {
        top_p: 0.7,
        top_k: 50,
      },
      input: {
        messages: [
          {
            role: 'user',
            content: [
              {
                image: imageUrl,
              },
              {
                text: `å‡è®¾ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ä¸­åŒ»ï¼Œéå¸¸æ“…é•¿è¿›è¡ŒèˆŒè¯Šï¼Œä½ ç›®å‰æ­£åœ¨å¡«å†™æˆ‘ä»¬åŒ»é™¢è§„å®šçš„èˆŒè¯Šç—…ä¾‹ï¼Œç—…ä¾‹è¦æ±‚å¡«å†™çš„5é¡¹æ–¹é¢ï¼ˆè‹”è´¨ã€è‹”è‰²ã€èˆŒè‰²ã€èˆŒå½¢ã€èˆŒç¥ï¼‰ã€‚ä½ éœ€è¦ä»å›¾ç‰‡ä¸­ä»”ç»†çš„è§‚å¯Ÿç”¨æˆ·çš„èˆŒå¤´æƒ…å†µï¼Œå¹¶å¡«å†™å®Œæˆè¿™5é¡¹ã€‚
1. èˆŒè´¨ï¼šèˆŒè‹”çš„åšè–„ï¼Œæ˜¯å¦èƒ½çœ‹åˆ°èˆŒä½“æœ¬èº«ï¼ŸèˆŒè‹”æ˜¯å¦æ¹¿æ¶¦ï¼Œé€‚ä¸­è¿˜æ˜¯å¹²ç‡¥ç²—ç³™ï¼ŸèˆŒè‹”æ˜¯å¦ç»†è…»ä¸æ˜“æŒ‚å»ï¼Ÿå¹¶ç»™å‡ºç»“è®ºèˆŒè´¨æ˜¯è–„è‹”, åšè‹”, æ¶¦è‹”, æ»‘è‹”, ç‡¥è‹”, ç³™è‹”, è…»è‹”, è…è‹”, å‰¥è‹”, ç±»å‰¥è‹”, èŠ±å‰¥è‹”, åœ°å›¾èˆŒ, é•œé¢èˆŒå“ªç§ï¼Ÿ
2. è‹”è‰²ï¼šèˆŒè‹”çš„é¢œè‰²æ˜¯ç™½è‰²è‹”ã€è–„ç™½è‹”ã€è–„ç™½æ¶¦è‹”ã€è–„ç™½å¹²è‹”ã€è–„ç™½æ»‘è‹”ã€ç™½åšè‹”ã€ç™½åšç‡¥è‹”ã€ç™½åšè…»è‹”ã€ç§¯ç²‰è‹”ã€è–„é»„è‹”ã€æ·±é»„è‹”ã€ç„¦é»„è‹”ã€é»„è…»è‹”ã€é»„ç‡¥è‹”ã€ç°é»‘å¹²è‹”ï¼Œè¿˜æ˜¯ç°é»‘æ¶¦è‹”ï¼Ÿ
2. èˆŒè‰²ï¼šèˆŒå¤´çš„é¢œè‰²æ˜¯æ·¡çº¢èˆŒ, æ·¡ç™½èˆŒ, æ¯ç™½èˆŒ, çº¢èˆŒ, ç»›èˆŒ, ç´«èˆŒ, ç»›ç´«èˆŒ, æ·¡ç´«èˆŒ, ç˜€æ–‘ã€ç˜€ç‚¹èˆŒ, é’èˆŒï¼Ÿæ˜¯å¦æœ‰æ–‘å—ï¼Ÿ
3. èˆŒå½¢ï¼šåˆ¤æ–­æ˜¯è€èˆŒ(èˆŒå¤´è¡¨é¢ç²—ç³™ï¼Œé¢œè‰²æš—æ·¡ï¼Œçœ‹èµ·æ¥è¾ƒè€), æ·¡å«©èˆŒ, çº¢å«©èˆŒ, èƒ–å¤§èˆŒ, é½¿ç—•èˆŒ, è‚¿èƒ€èˆŒ, çº¢ç˜¦èˆŒ, æ·¡ç˜¦èˆŒ, ç‚¹ã€åˆºèˆŒ, è£‚çº¹èˆŒï¼ˆèˆŒå¤´è¡¨é¢æœ‰ä¸åŒå½¢çŠ¶çš„è£‚çº¹ï¼Œæœ‰çš„è¢«èˆŒè‹”è¦†ç›–ï¼Œæœ‰çš„æ²¡æœ‰ï¼‰
4. èˆŒç¥ï¼šåˆ¤æ–­èˆŒå¤´çš„ç¥æ€æ˜¯è£èˆ(èˆŒå¤´é¢œè‰²é²œçº¢ä¸”æœ‰å…‰æ³½ï¼Œæ´»åŠ¨è‡ªå¦‚)è¿˜æ˜¯æ¯èˆŒ(èˆŒå¤´é¢œè‰²æš—æ·¡æ— å…‰ï¼Œæ´»åŠ¨ä¸çµæ´»)ï¼Ÿ
                `,
              },
            ],
          },
        ],
      },
    };

    _// è°ƒç”¨qwen-vlæ¨¡å‹_
    const qWenVLData: IQwenVlData = await this.apiService.getQwenVLMax(vlBody);

    if (qWenVLData) {
      const { usage, output } = qWenVLData;

      this.ctx.logger.info('qwen-vl-maxæ¨¡å‹çš„tokenæ¶ˆè€—ï¼š', usage);

      _// è°ƒç”¨ qwen-maxæ¨¡å‹çš„å‚æ•°_
      const params: OpenAI.Chat.ChatCompletionCreateParams = {
        messages: [
          {
            role: 'system',
            content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ä¸­åŒ»ï¼Œéå¸¸æ“…é•¿è¿›è¡ŒèˆŒè¯Šï¼Œé€šè¿‡è§‚å¯ŸèˆŒè±¡ä»¥äº†è§£ç—…æƒ…çš„è¯Šå¯Ÿæ–¹æ³•ã€‚æ‰€è°“èˆŒè±¡ï¼Œæ˜¯æŒ‡èˆŒè´¨å’ŒèˆŒè‹”è¿™ä¸¤å¤§å—çš„å½¢è±¡ã€‚
èˆŒè´¨åŒ…æ‹¬ï¼šèˆŒç¥ã€èˆŒè‰²ã€èˆŒå½¢ä¸‰ç±»ã€‚è¿™ä¸‰ç±»ä¸­åˆå…·æœ‰å…·ä½“çš„åˆ¤å®šæ ‡å‡†ï¼Œæ•°æ®å¦‚ä¸‹çš„JSON: \`\`\`json\n${JSON.stringify(
              SHENZHI_DATA
            )}\n\`\`\`
èˆŒæ€åŒ…æ‹¬ï¼šè‹”è´¨ã€è‹”è‰²ä¸¤ç±»ã€‚è¿™ä¸¤ç±»ä¸­åˆå…·æœ‰å…·ä½“çš„åˆ¤å®šæ ‡å‡†ï¼Œæ•°æ®å¦‚ä¸‹çš„JSON: \`\`\`json\n${JSON.stringify(
              SHETAI_DATA
            )}\n\`\`\`
ä½ éœ€è¦æ ¹æ®ç”¨æˆ·ä¼ æ¥çš„å¯¹èˆŒå¤´çš„æè¿°å†…å®¹ï¼Œæ¥åˆ¤æ–­æœ€ç¬¦åˆèˆŒè´¨å’ŒèˆŒæ€çš„å…·ä½“æƒ…å†µã€‚å¹¶è¿”å›ä»¥ä¸‹çš„JSONæ ¼å¼ç»™åˆ°ç”¨æˆ·ï¼ŒJSONçš„æ ¼å¼ç¬¦åˆtypescriptçš„interafaceæ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š
interface DiagnosisResponse {
  comment: string,
  data: {
    // è‹”è´¨
    è‹”è´¨: {
      name: string;
      feature: string;
      diagnosis: string;
    };
    // è‹”è‰²
    è‹”è‰²: {
      name: string;
      feature: string;
      diagnosis: string;
    },
    // èˆŒç¥
    èˆŒç¥: {
      name: string;
      feature: string;
      diagnosis: string;
    };
    // èˆŒè‰²
    èˆŒè‰²: {
      name: string;
      feature: string;
      diagnosis: string;
    };
    // èˆŒå½¢
    èˆŒå½¢: {
      name: string;
      feature: string;
      diagnosis: string;
    };
  };
};
å…¶ä¸­çš„commentå­—æ®µéœ€è¦åŒ…å«ä¸‹é¢4ç‚¹ï¼Œè¯·éƒ½æ”¾åœ¨commentå­—æ®µä¸­æˆä¸ºä¸€æ®µè¯ï¼ï¼š
1.æ€»ç»“ç”¨æˆ·èˆŒå¤´çš„ç‰¹ç‚¹
2.è¯Šæ–­çŠ¶æ€
3.é¥®é£Ÿå»ºè®®
4.ç”Ÿæ´»æ–¹å¼å»ºè®®
å…¶ä¸­çš„dataå­—æ®µæ˜¯è‹”è´¨ã€è‹”è‰²ã€èˆŒç¥ã€èˆŒè‰²ã€èˆŒå½¢çš„å…·ä½“è¯Šæ–­æƒ…å†µçš„æ˜ å°„å…³ç³»ï¼Œä½ éœ€è¦æ ¹æ®ç”¨æˆ·çš„æè¿°å†…å®¹ï¼Œæ¥åˆ¤æ–­æœ€ç¬¦åˆçš„ä¸€ä¸ªåˆ¤å®šæ ‡å‡†ï¼Œè¯·åŠ¡å¿…æŒ‰ç…§JSONçš„æ ¼å¼è¿”å›ï¼Œå¦åˆ™æˆ‘ä¼šè¢«å¼€é™¤åŒ»é™¢çš„ï¼
`,
          },
          {
            role: 'user',
            _// qwen-vl-maxæ¨¡å‹çš„å›å¤ï¼ˆå¯¹äºèˆŒå¤´çš„ç»†èŠ‚æè¿°ï¼‰_
            content: output.choices[0].message.content[0].text,
          },
        ],
        model: 'qwen-plus',
      };

      _// è¯·æ±‚qwen-maxæ¨¡å‹_
      const qWenMaxData = await this.apiService.getQwenChat(params);
      const content = qWenMaxData.choices[0].message?.content;

      this.ctx.logger.info('qwen-maxæ¨¡å‹çš„tokenæ¶ˆè€—ï¼š', qWenMaxData?.usage);

      return {
        success: !!content,
        data: content,
      };
    } else {
      return {
        success: false,
        info: 'è°ƒç”¨qwen-vl-maxå¤±è´¥',
      };
    }
  }
}
```

å¯ä»¥çœ‹åˆ°æˆ‘åˆ†åˆ«è°ƒç”¨äº† `qwen-vl-max` å’Œ `qwen-plus` ä¸¤ä¸ªæ¨¡å‹ã€‚

`qwen-vl-max` æ˜¯é€šä¹‰åƒé—®çš„è§†è§‰ç†è§£æ¨¡å‹ï¼Œå®ƒä¹Ÿæ”¯æŒæ–‡å­—å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼Œæˆ‘æœ¬æ¥å°è¯•çš„æ˜¯ä½¿ç”¨å®ƒç›´æ¥ç†è§£ç…§ç‰‡ï¼Œå¹¶ä¸”ç»™å‡ºå‰ç«¯éœ€è¦çš„ JSONã€‚ä½†æ˜¯æˆ‘å‘ç°å®ƒçš„æ–‡æœ¬ç”Ÿæˆèƒ½åŠ›æ²¡æœ‰ `qwen-plus` ç¨³å®šå’Œå‡ºè‰²ï¼Œç»å¸¸ä¼šå‡ºç°ç»™ä¸å‡ºæŒ‡å®šçš„ JSONï¼Œç”šè‡³å¼€å§‹èƒ¡è¯´çš„é—®é¢˜ï¼Œä½†æ˜¯ä½¿ç”¨ `qwen-plus` å°±åŸºæœ¬ä¸ä¼šå‡ºç°ã€‚

é¡ºä¾¿è¯´ä¸‹å¦‚ä½•è®©å¤§æ¨¡å‹è¾“å‡º JSONï¼Œç„¶ååœ¨æœåŠ¡ç«¯å’Œåç«¯è§£æ JSON è¿™æ–¹é¢åœ¨ AI åº”ç”¨çš„å¼€å‘ä¸­æ˜¯ååˆ†é‡è¦çš„ã€‚æœ‰ä¸äº†è§£çš„æœ‹å‹å¯çœ‹[ã€Š å¤§è¯­è¨€æ¨¡å‹ä¸‹çš„ JSON æ•°æ®æ ¼å¼äº¤äº’ ã€‹](https://mp.weixin.qq.com/s/gMdQBlTdvGbhzi_NL3HGXQ)ï¼Œè®²çš„å¾ˆæ˜ç™½ï¼

è¿™æ˜¯åç«¯è¿”å›çš„æ•°æ®ï¼Œæˆ‘ä»¬å‰ç«¯æ‹¿åˆ°è¿›è¡Œä¸€å®šç¨‹åº¦çš„æ–‡æœ¬è§£æå°±å¯ä»¥ä½¿ç”¨

![](static/WPExbPDnboCmlOxKYC1ciJL1nmc.png)

è¿™è¾¹è§£æå¤§æ¨¡å‹è¿”å›çš„ json æ•°æ®çš„å‡½æ•°å¦‚ä¸‹ï¼š

```javascript
function parseAIJSON(aiContent) {
  const content = aiContent.replace(/\\n/g, "");
  const regex = /```json\s([\s\S]*?)\s```/;
  const matches = content.match(regex);

  if (matches && matches.length) {
    try {
      const jsonString = matches[1];
      const data = JSON.parse(jsonString);

      return data;
    } catch (error) {
      console.error(error);
      return null;
    }
  } else {
    return null;
  }
}
```

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒç®€å•çš„ AI åº”ç”¨ Demoï¼Œä½†æ˜¯ä¹Ÿæ­£æ˜¯å› ä¸º AI å¤§æ¨¡å‹çš„åŠ æŒã€‚æ‰èƒ½è®©æ•´ä¸ªå¼€å‘è¿‡ç¨‹å˜å¾—å¦‚æ­¤çš„ç®€å•ï¼Œå¦‚æœæ²¡æœ‰å¤§æ¨¡å‹æä¾›çš„ API èƒ½åŠ›ï¼Œåç«¯å®ç°éƒ¨åˆ†è¿˜æ˜¯ç›¸å¯¹è€Œè¨€å¾ˆå¤æ‚çš„ï¼Œæˆ‘ä»¬ä¸ä»…éœ€è¦è®­ç»ƒä¸€ä¸ªèƒ½å¤Ÿè¯†åˆ«èˆŒè‹”çš„è§†è§‰ç†è§£æ¨¡å‹ï¼Œè®©è§†è§‰ç†è§£æ¨¡å‹è¾“å‡ºè¿™ä¸ªèˆŒè±¡çš„ç‰¹å¾æ•°æ®ã€‚æˆ‘ä»¬è¿˜è¦åœ¨èˆŒè¯Šçš„æ•°æ®åº“ä¸­ï¼Œè‡ªå·±æ ¹æ®ç‰¹å¾æ•°æ®ï¼Œæ‰‹æŒ«å¯¹åº”çš„ç‰¹å¾ç»“æœã€‚

å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰åœ¨ AI å¤§æ¨¡å‹çš„åŠ æŒä¸‹ï¼Œ å‰ç«¯å¼€å‘ä¸€äº›æœ‰è¶£ã€ä¸ªæ€§åŒ–çš„åº”ç”¨å˜å¾—çœŸçš„ååˆ†ç®€å•ã€‚ä¹‹åæˆ‘ä¼šåŸºäºå›½å†…çš„å¤§æ¨¡å‹ï¼ˆè±†åŒ…ã€Kimiã€é€šä¹‰ã€æ™ºè°±æ¸…è¨€ç­‰ï¼‰ï¼Œå¹¶ç»“åˆ LangChain çš„å¼€æºå·¥å…·ï¼Œå¼€å‘æ›´å¤šæœ‰æ„æ€çš„å¤§æ¨¡å‹åº”ç”¨ï¼ˆ9 æœˆå‰ä¼šæ›´æ–°å®Œ 10 ä¸ª AI åº”ç”¨  + è§†é¢‘ï¼‰ã€‚

